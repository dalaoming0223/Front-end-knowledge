# 【Vue数据监视 v-model双向绑定】

### Vue监视数据的原理

```
Vue监视数据的原理:
	1.vue会监视data中所有层次的数据
    2.如何监测对象中的数据?
        通过setter实现监视，且要在new Vue时就要传入要监测的数据
    		(1).对象中后追加的属性，Vue默认不做响应式处理
            (2).如需给后添加的属性做响应式，请使用如下API:
            	Vue.set(target, propertyName/index, value) 或
                vm.$set(target, propertyName/index，value)
	3.如何监测数组中的数据?
        通过包裹数组更新元素的方法实现，本质就是做了两件事:
			(1).调用原生对应的方法对数组进行更新
			(2).重新解析模板，进而更新页面
	4.在Vue修改数组中的某个元素一定要用如下方法:
		(1).使用这些API:push()、pop()、shift()、unshift()、splice()、sort()、reverse()
		(2).Vue.set() 或 vm.$set()
	特别注意: Vue.set() 和 vm.$set() 不能给 vm 或 vm的根数据对象 添加属性!!!
```

## 1.Vue数据监视

### 1.1问题演示

先来个案例引入一下：

```html
<!-- 准备好一个容器-->
<div id="root">
    <h2>人员列表</h2>
    <button @click="updateMei">更新马冬梅的信息</button>
    <ul>
        <li v-for="(p,index) of persons" :key="p.id">
            {{p.name}}-{{p.age}}-{{p.sex}}
        </li>
    </ul> 
</div>

<script type="text/javascript">
    Vue.config.productionTip = false

    const vm = new Vue({
        el:'#root',
        data:{
            persons:[
                {id:'001',name:'马冬梅',age:30,sex:'女'},
                {id:'002',name:'周冬雨',age:31,sex:'女'},
                {id:'003',name:'周杰伦',age:18,sex:'男'},
                {id:'004',name:'温兆伦',age:19,sex:'男'}
            ]
        },
        methods: {
            updateMei(){
                // this.persons[0].name = '马老师' //奏效
                // this.persons[0].age = 50 //奏效
                // this.persons[0].sex = '男' //奏效
                this.persons[0] = {id:'001',name:'马老师',age:50,sex:'男'} //不奏效
                // this.persons.splice(0,1,{id:'001',name:'马老师',age:50,sex:'男'})
            }
        }
    }) 

</script>
```

点击更新马冬梅的信息，马冬梅的数据并没有发生改变。

[![image-20220628130108394](https://camo.githubusercontent.com/9c1daa0314c933ed173d41971528d178c3e4e450429f76a10a4a2c8bb4a87882/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f63313761346238313263623533306630653662323736316265636562646663652e706e67)](https://camo.githubusercontent.com/9c1daa0314c933ed173d41971528d178c3e4e450429f76a10a4a2c8bb4a87882/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f696d675f636f6e766572742f63313761346238313263623533306630653662323736316265636562646663652e706e67)我们来看看控制台：

[![image-20220628130253077](https://camo.githubusercontent.com/d384a6d0c8c2e053fe681e55c90e955210d18b678b62bcc7fcd2a985a51a457f/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f383765653834653135343533373464613635376135303436663430343063636431376465313566342e706e67)](https://camo.githubusercontent.com/d384a6d0c8c2e053fe681e55c90e955210d18b678b62bcc7fcd2a985a51a457f/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f383765653834653135343533373464613635376135303436663430343063636431376465313566342e706e67)

控制台上的数据发生了改变，说明，这个更改的数据并没有被 vue 监测到。

### 1.2模拟一个数据监测

> 代码

```JavaScript
let data = {
  name: '尚硅谷',
  address: '北京',
}

function Observer(obj) {
  // 汇总对象中所有的属性形成一个数组
  const keys = Object.keys(obj)
  // 遍历
  keys.forEach((k) => {
    Object.defineProperty(this, k, {
      get() {
        return obj[k]
      },
      set(val) {
        console.log(`${k}被改了，我要去解析模板，生成虚拟DOM.....我要开始忙了`)
        obj[k] = val
      }
    })
  })
}

// 创建一个监视的实例对象，用于监视data中属性的变化
const obs = new Observer(data)
console.log(obs)

// 准备一个vm实例对象
let vm = {}
vm._data = data = obs
```

### 1.3Vue.set 的使用

`Vue.set(target，propertyName/index，value) `或

```
vm.$set(target，propertyName/index，value)
```

向响应式对象中添加一个 property，并确保这个新 property 同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新 property，因为 Vue 无法探测普通的新增 property (比如 `vm.myObject.newProperty = 'hi'`)

```html
<!-- 准备好一个容器-->
<div id="root">
    <h1>学生信息</h1>
    <button @click="addSex">添加性别属性，默认值：男</button> <br/>
</div>

<script type="text/javascript">
    Vue.config.productionTip = false //阻止 vue 在启动时生成生产提示。

    const vm = new Vue({
        el:'#root',
        data:{
            student:{
                name:'tom',
                age:18,
                hobby:['抽烟','喝酒','烫头'],
                friends:[
                    {name:'jerry',age:35},
                    {name:'tony',age:36}
                ]
            }
        },
        methods: {
            addSex(){
                // Vue.set(this.student,'sex','男')
                this.$set(this.student,'sex','男')
            }
        }
    })
</script>
```

`Vue.set() `或 `vm.$set `有缺陷：

[![image-20220629113903480](https://camo.githubusercontent.com/2668c3a1954b0cd5b1b9c66c4fa6c6815e6ae9b0bb98463830192e1dc324b0c3/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f646137663337616166643264633939643332313136333036376639636136343266343036383539332e706e67)](https://camo.githubusercontent.com/2668c3a1954b0cd5b1b9c66c4fa6c6815e6ae9b0bb98463830192e1dc324b0c3/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f646137663337616166643264633939643332313136333036376639636136343266343036383539332e706e67)

### 1.4监测数组

看完了 vue 监测对象中的数据，再来看看 vue 如何监测 数组里的数据

```
<!-- 准备好一个容器-->
<div id="root">
    <h2>爱好</h2>
    <ul>
        <li v-for="(h,index) in student.hobby" :key="index">
            {{h}}
        </li>
    </ul>
    <h2>朋友们</h2>
    <ul>
        <li v-for="(f,index) in student.friends" :key="index">
            {{f.name}}--{{f.age}}
        </li>
    </ul>
</div>

<script type="text/javascript">
    Vue.config.productionTip = false //阻止 vue 在启动时生成生产提示。

    const vm = new Vue({
        el:'#root',
        data:
            student:{
                name:'tom',
                age:{
                    rAge:40,
                    sAge:29,
                },
                hobby:['抽烟','喝酒','烫头'],
                friends:[
                    {name:'jerry',age:35},
                    {name:'tony',age:36}
                ]
            }
        },
        methods: {
            
        }
    })
</script>
```

[![image-20220629114734366](https://camo.githubusercontent.com/1bb1378ca6b1db9780e41b838752ba27e901c802e4a7afa40f7eef3ba61a375f/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f373330346537666666393435303562613664303264663364653635366561333963613465363331662e706e67)](https://camo.githubusercontent.com/1bb1378ca6b1db9780e41b838752ba27e901c802e4a7afa40f7eef3ba61a375f/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f373330346537666666393435303562613664303264663364653635366561333963613465363331662e706e67)

> 所以我们通过 vm._data.student.hobby[0] = ‘aaa’ // 不奏效
>
> `vue `监测在数组那没有 getter 和 setter，所以监测不到数据的更改，也不会引起页面的更新

[![image-20220629114843565](https://camo.githubusercontent.com/db095710b6199d904e34e7ed36f820ad51cf327b313c661c0fce150576c26058/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f323538376631313261353236626166616234333034323263303835316334616330323864353837612e706e67)](https://camo.githubusercontent.com/db095710b6199d904e34e7ed36f820ad51cf327b313c661c0fce150576c26058/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f323538376631313261353236626166616234333034323263303835316334616330323864353837612e706e67)

既然 vue 在对数组无法通过 getter 和 setter 进行数据监视，那 vue 到底如何监视数组数据的变化呢？

vue对数组的监测是通过 包装数组上常用的用于修改数组的方法来实现的。

vue官网的解释：

[![image-20220629114924545](https://camo.githubusercontent.com/d8972b9cdfde218592d894ecef448745fd68f3480d110d041d2c0f8284016ac7/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f626433623837326561363633646639613764366435643564373761646538666337613064656137622e706e67)](https://camo.githubusercontent.com/d8972b9cdfde218592d894ecef448745fd68f3480d110d041d2c0f8284016ac7/68747470733a2f2f69302e6864736c622e636f6d2f6266732f616c62756d2f626433623837326561363633646639613764366435643564373761646538666337613064656137622e706e67)

### 1.5练习

> 代码

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="/script/vue.js"></script>
</head>
<body>
  <style>button {margin-top: 10px;}</style>

<div id="root">
  <h1>学生信息</h1>
  <button @click="student.age++">年龄+1岁</button> <br />
  <button @click="addSex">添加性别属性，默认值：男</button> <br />
  <button @click="student.sex = '未知' ">修改性别</button> <br />
  <button @click="addFriend">在列表首位添加一个朋友</button> <br />
  <button @click="updateFirstFriendName">修改第一个朋友的名字为：张三</button> <br />
  <button @click="addHobby">添加一个爱好</button> <br />
  <button @click="updateHobby">修改第一个爱好为：开车</button> <br />
  <button @click="removeSmoke">过滤掉爱好中的抽烟</button> <br />
  <h3>姓名：{{ student.name }}</h3>
  <h3>年龄：{{ student.age }}</h3>
  <h3 v-if="student.sex">性别：{{student.sex}}</h3>
  <h3>爱好：</h3>
  <ul>
    <li v-for="(h,index) in student.hobby" :key="index">{{ h }} </li>
  </ul>
  <h3>朋友们：</h3>
  <ul>
    <li v-for="(f,index) in student.friends" :key="index">{{ f.name }}--{{ f.age }}</li>
  </ul>
</div>

<script type="text/javascript">
  Vue.config.productionTip = false

  const vm = new Vue({
    el: '#root',
    data: {
      student: {
        name: 'tom',
        age: 18,
        hobby: ['抽烟', '喝酒', '烫头'],
        friends: [
          { name: 'jerry', age: 35 },
          { name: 'tony', age: 36 }
        ]
      }
    },
    methods: {
      addSex() {
        // Vue.set(this.student,'sex','男')
        this.$set(this.student, 'sex', '男')
      },
      addFriend() {
        this.student.friends.unshift({ name: 'jack', age: 70 })
      },
      updateFirstFriendName() {
        this.student.friends[0].name = '张三' 
      },
      addHobby() {
        this.student.hobby.push('学习')
      },
      updateHobby() {
        // this.student.hobby.splice(0,1,'开车')
        // Vue.set(this.student.hobby,0,'开车')
        this.$set(this.student.hobby, 0, '开车')
      },
      removeSmoke() {
        this.student.hobby = this.student.hobby.filter((h) => {
          return h !== '抽烟'
        })
      }
    }
  })
  </script>
</body>
</html>
```



### 1.6总结

Vue监视数据的原理：

- vue会监视data中所有层次的数据

- 如何监测对象中的数据？

  通过setter实现监视，且要在new Vue时就传入要监测的数据。

  - 对象中后追加的属性，Vue默认不做响应式处理

  - 如需给后添加的属性做响应式，请使用如下API：

    `Vue.set(target，propertyName/index，value) `或

    `vm.$set(target，propertyName/index，value)`

- 如何监测**数组**中的数据？

  通过包裹数组更新元素的方法实现，本质就是做了两件事：

  - 调用原生对应的方法对数组进行更新
  - 重新解析模板，进而更新页面

- 在Vue修改数组中的某个元素一定要用如下方法：

  - 使用这些API:**push()、pop()、shift()、unshift()、splice()、sort()、reverse()**
  - `Vue.set()` 或 `vm.$set()`

> 特别注意：`Vue.set()` 和 `vm.$set() `不能给vm 或 vm的根数据对象 添加属性！！！ 例:`Vue.set(this,…,…)`或`this.$set(this,…,…)`

## 2.v-model双向绑定

## 收集表单数据

```html
收集表单数据:
	若: <input type="text"/>，则v-model收集的是value的值，用户输入的就是value值
	若: <input type="radio"/>，则v-model收集的是value值，且要给标签配置value值
	若: <input type="checkbox"/>
        1.没有配置input的value属性，那么收集的就是checked (勾选 or 未勾选，是布尔值)
		2.配置input的value属性:
			(1).v-model的初始值是非数组，那么收集的就是checked (勾选 or 未勾选，是布尔值)
			(2).v-model的初始值是数组，那么收集的就是value组成的数组
	备注: v-model的三个修饰符
			lazy: 失去焦点再收集数据
            number: 输入字符串转为有效的数字
            trim: 输入首位空格过滤

<!-- 准备好一个容器-->
<div id="root">
    <form @submit.prevent="demo">
        账号：<input type="text" v-model.trim="userInfo.account"> <br/><br/>
        密码：<input type="password" v-model="userInfo.password"> <br/><br/>
        年龄：<input type="number" v-model.number="userInfo.age"> <br/><br/>
        性别：
        男<input type="radio" name="sex" v-model="userInfo.sex" value="male">
        女<input type="radio" name="sex" v-model="userInfo.sex" value="female"> <br/><br/>
        爱好：
        学习<input type="checkbox" v-model="userInfo.hobby" value="study">
        打游戏<input type="checkbox" v-model="userInfo.hobby" value="game">
        吃饭<input type="checkbox" v-model="userInfo.hobby" value="eat">
        <br/><br/>
        所属校区
        <select v-model="userInfo.city">
            <option value="">请选择校区</option>
            <option value="beijing">北京</option>
            <option value="shanghai">上海</option>
            <option value="shenzhen">深圳</option>
            <option value="wuhan">武汉</option>
        </select>
        <br/><br/>
        其他信息：
        <textarea v-model.lazy="userInfo.other"></textarea> <br/><br/>
        <input type="checkbox" v-model="userInfo.agree">阅读并接受<a href="http://www.atguigu.com">《用户协议》</a>
        <button>提交</button>
    </form>
</div>
</body>

<script type="text/javascript">
    Vue.config.productionTip = false

    new Vue({
        el:'#root',
        data:{
            userInfo:{
                account:'',
                password:'',
                age:18,
                sex:'female',
                hobby:[],
                city:'beijing',
                other:'',
                agree:''
            }
        },
        methods: {
            demo(){
                console.log(JSON.stringify(this.userInfo))
            }
        }
    })
</script>
```

### 2.1收集表单数据

若：<input type="radio"/>，则v-model收集的是value值，且要给标签配置value值。

若<input type="checkbox"/>

没有配置input的value属性，那么收集的就是checked（勾选 or 未勾选，是布尔值）

配置input的value属性:

v-model的初始值是非数组，那么收集的就是checked（勾选 or 未勾选，是布尔值）

v-model的初始值是数组，那么收集的的就是value组成的数组

## 过滤器

```

过滤器:
	定义: 对要显示的数据进行特定格式化后再显示 (适用于一些简单逻辑的处理)
	语法:
		1.注册过滤器: Vue.filter(name,callback) 或 new Vue({filters:{}})
		2.使用过滤器: {{ xxx | 过滤器名}} 或 v-bind:属性= "xxx | 过滤器名"
	备注:
		1.过滤器也可以接收额外参数、多个过滤器也可以串联
        2.并没有改变原本的数据，是产生新的对应的数据
        
//全局过滤器
Vue.filter('mySlice',function(value){
	return value.slice(0,4)
})

//局部过滤器
filters:{
    timeFormater(value,str='YYYY年MM月DD日 HH:mm:ss'){
        // console.log('@',value)
        return dayjs(value).format(str)
    }
}
```